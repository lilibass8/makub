# Firebase Security Rules - ุดุฑุญ ุงูููุงุนุฏ

## ๐ ูุธุฑุฉ ุนุงูุฉ

ุชู ุฅูุดุงุก ููุงุนุฏ ุฃูุงู ุดุงููุฉ ูุญูุงูุฉ ุจูุงูุงุช ุงููุณุชุฎุฏููู ูู Firestore ู Storage. ุงูููุงุนุฏ ุชุนุชูุฏ ุนูู ูุธุงู ุงูุฃุฏูุงุฑ (Role-Based Access Control).

---

## ๐ Firestore Security Rules

### ุงูููู: `firestore.rules`

#### 1๏ธโฃ Users Collection (ูุฌููุนุฉ ุงููุณุชุฎุฏููู)

**ุงููุฑุงุกุฉ (Read):**
- โ ุฃู ูุณุชุฎุฏู ูุณุฌู ุฏุฎูู ููููู ูุฑุงุกุฉ ูุนูููุงุช ุงููุณุชุฎุฏููู ุงูุขุฎุฑูู (ููุนุฑุถ ุงูุนุงู)

**ุงูุฅูุดุงุก (Create):**
- โ ูููู ูููุณุชุฎุฏู ุฅูุดุงุก ูููู ุงูุดุฎุตู ููุท
- โ ูุฌุจ ุฃู ูููู uid = request.auth.uid
- โ ูุฌุจ ุฃู ุชุญุชูู ุนูู ุฌููุน ุงูุญููู ุงููุทููุจุฉ
- โ ููุน ุงูุญุณุงุจ ูุฌุจ ุฃู ูููู: `client` ุฃู `artist` ุฃู `owner`

**ุงูุชุญุฏูุซ (Update):**
- โ ุงููุณุชุฎุฏู ููููู ุชุญุฏูุซ ูููู ุงูุดุฎุตู ููุท
- โ ูุง ูููู ุชุบููุฑ uid ุฃู email

**ุงูุญุฐู (Delete):**
- โ ุงููุณุชุฎุฏู ููููู ุญุฐู ุญุณุงุจู ููุท

---

#### 2๏ธโฃ Artists Collection (ูุฌููุนุฉ ุงูุขุฑุชุณุช)

**ุงููุฑุงุกุฉ (Read):**
- โ ุงูุฌููุน ูููููู ูุฑุงุกุฉ ูููุงุช ุงูุขุฑุชุณุช (ูุนูููุงุช ุนุงูุฉ)

**ุงูุฅูุดุงุก (Create):**
- โ ููุท ุงููุณุชุฎุฏููู ูู ููุน `artist` ูููููู ุฅูุดุงุก ููู ุขุฑุชุณุช
- โ ูุฌุจ ุฃู ูููู userId = request.auth.uid

**ุงูุชุญุฏูุซ (Update):**
- โ ุงูุขุฑุชุณุช ููููู ุชุญุฏูุซ ูููู ููุท

**ุงูุญุฐู (Delete):**
- โ ุงูุขุฑุชุณุช ููููู ุญุฐู ูููู ููุท

---

#### 3๏ธโฃ Bookings Collection (ูุฌููุนุฉ ุงูุญุฌูุฒุงุช)

**ุงููุฑุงุกุฉ (Read):**
- โ ุงูุนููู ููููู ูุฑุงุกุฉ ุญุฌูุฒุงุชู
- โ ุงูุขุฑุชุณุช ููููู ูุฑุงุกุฉ ุงูุญุฌูุฒุงุช ุงูุฎุงุตุฉ ุจู

**ุงูุฅูุดุงุก (Create):**
- โ ุงููุณุชุฎุฏููู ุงููุณุฌููู ูููููู ุฅูุดุงุก ุญุฌูุฒุงุช
- โ ูุฌุจ ุฃู ูููู userId = request.auth.uid
- โ ุงูุญุงูุฉ ุงูุฃูููุฉ ูุฌุจ ุฃู ุชููู `pending`

**ุงูุชุญุฏูุซ (Update):**
- โ ุงูุนููู ููููู ุชุญุฏูุซ ุญุฌุฒู (ููุฅูุบุงุก)
- โ ุงูุขุฑุชุณุช ููููู ุชุญุฏูุซ ุญุฌูุฒุงุชู (ููุชุฃููุฏ/ุงูุฅููุงู)

**ุงูุญุฐู (Delete):**
- โ ููุท ุตุงุญุจ ุงูุญุฌุฒ ููููู ุญุฐูู

---

#### 4๏ธโฃ Spaces Collection (ูุฌููุนุฉ ุงููุณุงุญุงุช)

**ุงููุฑุงุกุฉ (Read):**
- โ ุงูุฌููุน ูููููู ูุฑุงุกุฉ ุงููุณุงุญุงุช ุงููุชุงุญุฉ

**ุงูุฅูุดุงุก (Create):**
- โ ููุท ุงููุณุชุฎุฏููู ูู ููุน `owner` ูููููู ุฅุถุงูุฉ ูุณุงุญุงุช
- โ ูุฌุจ ุฃู ูููู ownerId = request.auth.uid

**ุงูุชุญุฏูุซ (Update):**
- โ ูุงูู ุงููุณุงุญุฉ ููุท ููููู ุชุญุฏูุซูุง

**ุงูุญุฐู (Delete):**
- โ ูุงูู ุงููุณุงุญุฉ ููุท ููููู ุญุฐููุง

---

#### 5๏ธโฃ Space Bookings Collection (ุญุฌูุฒุงุช ุงููุณุงุญุงุช)

**ุงููุฑุงุกุฉ (Read):**
- โ ุงููุณุชุฃุฌุฑ ููููู ูุฑุงุกุฉ ุญุฌูุฒุงุชู
- โ ูุงูู ุงููุณุงุญุฉ ููููู ูุฑุงุกุฉ ุญุฌูุฒุงุช ูุณุงุญุงุชู

**ุงูุฅูุดุงุก (Create):**
- โ ุงููุณุชุฎุฏููู ุงููุณุฌููู ูููููู ุญุฌุฒ ุงููุณุงุญุงุช
- โ ูุฌุจ ุฃู ูููู userId = request.auth.uid
- โ ุงูุญุงูุฉ ุงูุฃูููุฉ: `pending`

**ุงูุชุญุฏูุซ (Update):**
- โ ุงููุณุชุฃุฌุฑ ููููู ุชุญุฏูุซ ุญุฌุฒู
- โ ูุงูู ุงููุณุงุญุฉ ููููู ุชุญุฏูุซ ุญุฌูุฒุงุช ูุณุงุญุชู

**ุงูุญุฐู (Delete):**
- โ ููุท ุงููุณุชุฃุฌุฑ ููููู ุญุฐู ุญุฌุฒู

---

## ๐ฆ Storage Security Rules

### ุงูููู: `storage.rules`

#### 1๏ธโฃ User Profile Images (`/users/{userId}/`)

- โ ุงููุณุชุฎุฏู ููููู ูุฑุงุกุฉ/ูุชุงุจุฉ/ุญุฐู ูููุงุชู ููุท
- โ ููุท ุงูุตูุฑ (image/*)
- โ ุญุฌู ุฃูุตู: 5MB

#### 2๏ธโฃ Artist Portfolio (`/artists/{artistId}/`)

**ุงููุฑุงุกุฉ:**
- โ ุงูุฌููุน ูููููู ูุดุงูุฏุฉ ุตูุฑ ุงูุขุฑุชุณุช

**ุงููุชุงุจุฉ:**
- โ ุงููุณุชุฎุฏููู ุงููุณุฌููู ููุท
- โ ููุท ุงูุตูุฑ
- โ ุญุฌู ุฃูุตู: 5MB

#### 3๏ธโฃ Space Images (`/spaces/{spaceId}/`)

**ุงููุฑุงุกุฉ:**
- โ ุงูุฌููุน ูููููู ูุดุงูุฏุฉ ุตูุฑ ุงููุณุงุญุงุช

**ุงููุชุงุจุฉ:**
- โ ุงููุณุชุฎุฏููู ุงููุณุฌููู ููุท
- โ ููุท ุงูุตูุฑ
- โ ุญุฌู ุฃูุตู: 5MB

#### 4๏ธโฃ Booking Files (`/bookings/{bookingId}/`)

- โ ุงููุณุชุฎุฏููู ุงููุณุฌููู ููุท
- โ ููุท ุงูุตูุฑ
- โ ุญุฌู ุฃูุตู: 5MB

---

## ๐ ููููุฉ ูุดุฑ ุงูููุงุนุฏ

### ุงูุทุฑููุฉ 1: Firebase Console (ูุงุฌูุฉ ุงูููุจ)

#### Firestore Rules:
1. ุงูุชุญ [Firebase Console](https://console.firebase.google.com)
2. ุงุฎุชุฑ ูุดุฑูุน `bellabox`
3. ุงุฐูุจ ุฅูู **Firestore Database**
4. ุงุถุบุท ุนูู ุชุจููุจ **Rules**
5. ุงูุณุฎ ูุงูุตู ูุญุชูู ููู `firestore.rules`
6. ุงุถุบุท **Publish**

#### Storage Rules:
1. ูู ููุณ ุงููุดุฑูุนุ ุงุฐูุจ ุฅูู **Storage**
2. ุงุถุบุท ุนูู ุชุจููุจ **Rules**
3. ุงูุณุฎ ูุงูุตู ูุญุชูู ููู `storage.rules`
4. ุงุถุบุท **Publish**

### ุงูุทุฑููุฉ 2: Firebase CLI

```bash
# ุชุซุจูุช Firebase CLI ุฅุฐุง ูู ููู ูุซุจุชุงู
npm install -g firebase-tools

# ุชุณุฌูู ุงูุฏุฎูู
firebase login

# ุชููุฆุฉ ุงููุดุฑูุน (ุฅุฐุง ูู ุชูู ูุฏ ูุนูุช)
firebase init

# ูุดุฑ ุงูููุงุนุฏ
firebase deploy --only firestore:rules
firebase deploy --only storage:rules

# ุฃู ูุดุฑ ุงููู ูุนุงู
firebase deploy
```

---

## ๐งช ุงุฎุชุจุงุฑ ุงูููุงุนุฏ

### ุงุฎุชุจุงุฑ Firestore Rules

ููููู ุงุฎุชุจุงุฑ ุงูููุงุนุฏ ูู Firebase Console:

1. ุงุฐูุจ ุฅูู **Firestore Database** โ **Rules**
2. ุงุถุบุท ุนูู **Rules Playground**
3. ุงุฎุชุจุฑ ุณููุงุฑูููุงุช ูุฎุชููุฉ:

**ูุซุงู 1: ูุณุชุฎุฏู ููุฑุฃ ูููู ุงูุดุฎุตู**
```
Operation: get
Location: /databases/(default)/documents/users/USER_ID
Authenticated: Yes (USER_ID)
Result: โ Allow
```

**ูุซุงู 2: ูุณุชุฎุฏู ูุญุงูู ุชุนุฏูู ููู ูุณุชุฎุฏู ุขุฎุฑ**
```
Operation: update
Location: /databases/(default)/documents/users/OTHER_USER_ID
Authenticated: Yes (USER_ID)
Result: โ Deny
```

**ูุซุงู 3: ุบูุฑ ูุณุฌู ูุญุงูู ุฅูุดุงุก ุญุฌุฒ**
```
Operation: create
Location: /databases/(default)/documents/bookings/BOOKING_ID
Authenticated: No
Result: โ Deny
```

---

## ๐ ุฃูุซูุฉ ุนูู ุงูุงุณุชุฎุฏุงู

### โ ูุณููุญ

```javascript
// 1. ูุณุชุฎุฏู ููุฑุฃ ูููู ุงูุดุฎุตู
const userProfile = await getDoc(doc(db, 'users', currentUser.uid));

// 2. ูุณุชุฎุฏู ูุญุฏุซ ุจูุงูุงุชู
await updateDoc(doc(db, 'users', currentUser.uid), {
  fullName: "ุงุณู ุฌุฏูุฏ",
  phone: "+968 91234567"
});

// 3. ุนููู ููุดุฆ ุญุฌุฒ ุฌุฏูุฏ
await addDoc(collection(db, 'bookings'), {
  userId: currentUser.uid,
  artistId: "artist123",
  status: "pending",
  // ... other fields
});

// 4. ุขุฑุชุณุช ููุฑุฃ ุญุฌูุฒุงุชู
const bookings = await getDocs(
  query(collection(db, 'bookings'), 
        where('artistId', '==', myArtistId))
);
```

### โ ููููุน

```javascript
// 1. ูุณุชุฎุฏู ูุญุงูู ุชุนุฏูู ููู ูุณุชุฎุฏู ุขุฎุฑ
await updateDoc(doc(db, 'users', 'OTHER_USER_ID'), {
  fullName: "ูุงูุฑ"
}); // โ Permission Denied

// 2. ูุณุชุฎุฏู ุนุงุฏู ููุดุฆ ููู ุขุฑุชุณุช
// (accountType != 'artist')
await addDoc(collection(db, 'artists'), {
  userId: currentUser.uid,
  // ...
}); // โ Permission Denied

// 3. ูุณุชุฎุฏู ูุบูุฑ uid ูู ูููู
await updateDoc(doc(db, 'users', currentUser.uid), {
  uid: "DIFFERENT_UID"
}); // โ Permission Denied

// 4. ุบูุฑ ูุณุฌู ููุดุฆ ุญุฌุฒ
await addDoc(collection(db, 'bookings'), {
  // ...
}); // โ Permission Denied (not authenticated)
```

---

## ๐ ูุณุชููุงุช ุงูุฃูุงู

| ุงููุฌููุนุฉ | ุงููุฑุงุกุฉ | ุงูุฅูุดุงุก | ุงูุชุญุฏูุซ | ุงูุญุฐู |
|---------|---------|---------|---------|--------|
| **users** | ูุณุฌููู ููุท | ุตุงุญุจ ุงูุญุณุงุจ | ุตุงุญุจ ุงูุญุณุงุจ | ุตุงุญุจ ุงูุญุณุงุจ |
| **artists** | ุงูุฌููุน | Artists ููุท | ุตุงุญุจ ุงูููู | ุตุงุญุจ ุงูููู |
| **bookings** | ุตุงุญุจ ุงูุญุฌุฒ/ุงูุขุฑุชุณุช | ูุณุฌููู | ุตุงุญุจ ุงูุญุฌุฒ/ุงูุขุฑุชุณุช | ุตุงุญุจ ุงูุญุฌุฒ |
| **spaces** | ุงูุฌููุน | Owners ููุท | ุตุงุญุจ ุงููุณุงุญุฉ | ุตุงุญุจ ุงููุณุงุญุฉ |
| **spaceBookings** | ุงููุณุชุฃุฌุฑ/ุงููุงูู | ูุณุฌููู | ุงููุณุชุฃุฌุฑ/ุงููุงูู | ุงููุณุชุฃุฌุฑ |

---

## โ๏ธ ููุงุญุธุงุช ูููุฉ

### 1. ุงูุญูุงูุฉ ูู ุงูุชุนุฏููุงุช ุงูุฎุทูุฑุฉ
ุงูููุงุนุฏ ุชููุน:
- โ ุชุบููุฑ uid ูููุณุชุฎุฏู
- โ ุชุบููุฑ email ูููุณุชุฎุฏู
- โ ุฅูุดุงุก ุญุฌุฒ ุจุงุณู ูุณุชุฎุฏู ุขุฎุฑ
- โ ุงููุตูู ุฅูู ุจูุงูุงุช ุงููุณุชุฎุฏููู ุงูุขุฎุฑูู

### 2. ุงูุชุญูู ูู ููุน ุงูุญุณุงุจ
- ูุฌุจ ุฃู ูููู accountType ูุงุญุฏ ูู: `client`, `artist`, `owner`
- ูุง ูููู ุชุบููุฑู ุจุนุฏ ุงูุฅูุดุงุก (ูููู ุชุนุฏูู ูุฐุง ุฅุฐุง ูุฒู)

### 3. ุงูุญููู ุงููุทููุจุฉ
ุนูุฏ ุฅูุดุงุก user profileุ ูุฌุจ ูุฌูุฏ:
- uid
- email
- fullName
- phone
- location
- accountType
- createdAt
- updatedAt

### 4. ุญุงูุงุช ุงูุญุฌูุฒุงุช
ุงูุญุงูุฉ ุงูุฃูููุฉ ููุญุฌูุฒุงุช ูุฌุจ ุฃู ุชููู `pending`

---

## ๐๏ธ ุชุฎุตูุต ุงูููุงุนุฏ

ุฅุฐุง ุฃุฑุฏุช ุชุนุฏูู ุงูููุงุนุฏ:

### ุฅุถุงูุฉ ุญูู ุฌุฏูุฏ ูุทููุจ
```javascript
function hasRequiredUserFields() {
  return request.resource.data.keys().hasAll([
    'uid', 'email', 'fullName', 'phone', 
    'location', 'accountType', 'createdAt', 'updatedAt',
    'newField' // ุฃุถู ุงูุญูู ุงูุฌุฏูุฏ ููุง
  ]);
}
```

### ุงูุณูุงุญ ุจุชุบููุฑ ูุนูููุงุช ุฅุถุงููุฉ
```javascript
allow update: if isOwner(userId) && 
                 request.resource.data.uid == resource.data.uid &&
                 // ูููู ุชุบููุฑ email ุงูุขู
                 isValidAccountType();
```

### ุฅุถุงูุฉ ุฏูุฑ ุฌุฏูุฏ (Admin)
```javascript
function isAdmin() {
  return isSignedIn() && 
         get(/databases/$(database)/documents/users/$(request.auth.uid)).data.accountType == 'admin';
}

// ุงุณุชุฎุฏุงู
allow read: if isAdmin();
```

---

## ๐ ุงูุฏุนู

ุฅุฐุง ูุงุฌูุช ูุดุงูู ูู ุงูููุงุนุฏ:

1. ุชุญูู ูู Firebase Console โ Firestore โ Rules
2. ุงุณุชุฎุฏู Rules Playground ููุงุฎุชุจุงุฑ
3. ุชุญูู ูู Auth state ูู ุงูุชุทุจูู
4. ุฑุงุฌุน console logs ููุฃุฎุทุงุก

---

## โ ุงูุฎูุงุตุฉ

ุงูููุงุนุฏ ุงูุญุงููุฉ ุชููุฑ:
- ๐ ุญูุงูุฉ ูุงููุฉ ูุจูุงูุงุช ุงููุณุชุฎุฏููู
- ๐ฅ ูุธุงู ุฃุฏูุงุฑ (Roles) ูุญุชุฑู
- ๐ ุงูุชุญูู ูู ุตุญุฉ ุงูุจูุงูุงุช
- ๐ซ ููุน ุงูุนูููุงุช ุบูุฑ ุงููุตุฑุญ ุจูุง
- ๐ธ ุญูุงูุฉ ุงููููุงุช ูู Storage

**ุชุฐูุฑ:** ุจุนุฏ ูุดุฑ ุงูููุงุนุฏุ ุงุฎุชุจุฑูุง ุฌูุฏุงู ูุจู ุงูุงูุชูุงู ููุฅูุชุงุฌ!
